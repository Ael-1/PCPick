<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Account Settings â€” PCPick</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="assets/icon.ico">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="index.html">
        <img src="assets/logo.png" alt="PCPick logo" class="logo-icon" />
        <span class="logo-wordmark"><span class="logo-pc">PC</span><span class="logo-pick">PICK</span></span>
      </a>
      <nav class="nav" id="main-nav">
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="products.html">Products</a></li>
          <li><a href="pcbuilder.html">PC Builder</a></li>
          <li><a href="prebuiltpc.html">Pre-built PCs</a></li>
          <li><a href="orders.html">My Orders</a></li>
        </ul>
      </nav>
      <div class="nav-actions">
        <a class="login" data-auth-visible="signed-out" href="login.html">Log In</a>
        <a class="btn signup" data-auth-visible="signed-out" href="signup.html">Sign Up</a>

        <!-- Theme Toggle -->
        <label class="theme-toggle">
          <input type="checkbox" id="theme-switch" />
          <span class="slider">
            <span class="sun"></span>
            <span class="moon"></span>
          </span>
        </label>
        <button class="menu-toggle" aria-label="Open menu" id="menu-toggle">&#9776;</button>
      </div>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="account-page container">
    <h1 class="account-title">Account Settings</h1>
    <p class="account-subtitle">Manage your account details and preferences</p>

    <!-- Profile Info -->
    <section class="settings-card">
      <h2>ðŸ‘¤ Profile Information</h2>
      <p class="settings-subtext">Update your personal information and contact details</p>

      <form class="settings-form" id="profile-form">
        <div class="form-row">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" placeholder="John Doe" id="fullName">
          </div>
          <div class="form-group">
            <label>Email Address</label>
            <input type="email" placeholder="johndoe@email.com" id="email">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Phone Number</label>
            <input type="text" placeholder="+1 (555) 123-4567" id="phone">
          </div>
          <div class="form-group">
            <label>Zip Code</label>
            <input type="text" placeholder="12345" id="zipCode">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Street Address</label>
            <input type="text" placeholder="123 Main Street" id="streetAddress">
          </div>
          <div class="form-group">
            <label>City</label>
            <input type="text" placeholder="New York" id="city">
          </div>
        </div>

        <hr>
        <button type="submit" class="btn save-btn">Save Changes</button>
      </form>
    </section>

    <!-- Password & Security -->
    <section class="settings-card">
      <h2>ðŸ”’ Password & Security</h2>
      <p class="settings-subtext">Update your password to keep your account secure</p>

      <form class="settings-form" id="password-form">
        <div class="form-group">
          <label>Current Password</label>
          <div class="password-field">
            <input type="password" placeholder="Enter current password" id="currentPassword">
            <button type="button" class="password-toggle" data-password-toggle="#currentPassword" data-visible-icon="assets/visible.png" data-hidden-icon="assets/hidden.png" aria-label="Show password">
              <img src="assets/hidden.png" alt="" aria-hidden="true">
            </button>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>New Password</label>
            <div class="password-field">
              <input type="password" placeholder="Enter new password" id="newPassword">
              <button type="button" class="password-toggle" data-password-toggle="#newPassword" data-visible-icon="assets/visible.png" data-hidden-icon="assets/hidden.png" aria-label="Show password">
                <img src="assets/hidden.png" alt="" aria-hidden="true">
              </button>
            </div>
          </div>
          <div class="form-group">
            <label>Confirm New Password</label>
            <div class="password-field">
              <input type="password" placeholder="Confirm new password" id="confirmPassword">
              <button type="button" class="password-toggle" data-password-toggle="#confirmPassword" data-visible-icon="assets/visible.png" data-hidden-icon="assets/hidden.png" aria-label="Show password">
                <img src="assets/hidden.png" alt="" aria-hidden="true">
              </button>
            </div>
          </div>
        </div>

        <div class="password-hint">
          <p><strong>Password requirements:</strong> At least 6 characters.</p>
        </div>

        <hr>
        <button type="submit" class="btn update-btn">Update Password</button>
      </form>
    </section>

        <!-- Delete Account -->
    <section class="settings-card danger-zone">
      <div class="danger-header">
        <div>
          <h2>Delete Account</h2>
          <p class="settings-subtext">Permanently delete your account and all data</p>
        </div>
        <button class="btn delete-btn" id="delete-account-btn">Delete</button>
      </div>
    </section>

  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="container">
      <p>&copy; <span id="year"></span> PCPick â€” All rights reserved.</p>
    </div>
  </footer>

  <script src="script.js"></script>
  <!-- Supabase CDN and update logic -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = 'https://wuxcglaecmmpdtoxgchu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1eGNnbGFlY21tcGR0b3hnY2h1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4Nzg0MjYsImV4cCI6MjA3NzQ1NDQyNn0.9yPYnqnTmc_aIES9GhwYK2tC5SVgp8D3J-iZYZ7hpvU';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Form Input Elements ---
    const profileForm = document.getElementById('profile-form');
    const passwordForm = document.getElementById('password-form');
    
    const fullNameInput = document.getElementById('fullName');
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone');
    const zipCodeInput = document.getElementById('zipCode');
    const streetAddressInput = document.getElementById('streetAddress');
    const cityInput = document.getElementById('city');
    
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const deleteButton = document.getElementById('delete-account-btn');

    /**
     * Loads the current user's data from auth.users and user_info
     * and populates the form fields.
     */
    async function loadUserProfile() {
      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      // 1. Populate data from auth.users
      if (user.user_metadata) {
        fullNameInput.value = user.user_metadata.full_name || '';
      }
      emailInput.value = user.email || '';

      // 2. Populate data from user_info table
      const { data: userInfo, error } = await supabase
        .from('user_info')
        .select('*')
        .eq('user_uid', user.id)
        .maybeSingle();

      if (error) {
        console.error('Error fetching user info:', error.message);
      }

      if (userInfo) {
        phoneInput.value = userInfo.phone_number || '';
        zipCodeInput.value = userInfo.zip_code || '';
        streetAddressInput.value = userInfo.street_address || ''; 
        cityInput.value = userInfo.city || '';
      }
    }

    /**
     * Handles the account deletion process by calling a Supabase Edge Function.
     */
    async function handleDeleteAccount() {
      const confirmation = confirm(
        'Are you sure you want to delete your account? This action is irreversible and will remove all your data.'
      );

      if (!confirmation) {
        return;
      }

      try {
        // Invoke the server-side function to perform the deletion
        const { data: { session } } = await supabase.auth.getSession();
        const { error } = await supabase.functions.invoke('super-api', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session.access_token}`
          }
        });

        if (error) {
          throw error;
        }

        alert('Your account has been successfully deleted.');
        // Log the user out on the client and redirect to the homepage
        await supabase.auth.signOut();
        window.location.href = 'index.html';

      } catch (error) {
        alert(`Failed to delete account: ${error.message}`);
      }
    }

    // --- Attach Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
      // Load user data as soon as the page is ready
      loadUserProfile();

      // --- Profile Form Listener (New Structure) ---
      if (profileForm) {
        profileForm.addEventListener('submit', async (event) => {
          event.preventDefault();

          const { data: { user } } = await supabase.auth.getUser();
          if (!user) {
            alert('You must be logged in to update your profile.');
            return;
          }

          // --- 1. Build update objects only for fields with input ---
          const authUpdates = {};
          if (emailInput.value) authUpdates.email = emailInput.value;
          if (fullNameInput.value) authUpdates.data = { full_name: fullNameInput.value };

          const userInfoUpdates = {};
          if (zipCodeInput.value) userInfoUpdates.zip_code = parseInt(zipCodeInput.value, 10);
          if (phoneInput.value) {
            // Remove non-numeric characters and parse as an integer
            const numericPhone = parseInt(phoneInput.value.replace(/\D/g, ''), 10);
            if (!isNaN(numericPhone)) userInfoUpdates.phone_number = numericPhone;
          }
          if (streetAddressInput.value) userInfoUpdates.street_address = streetAddressInput.value;
          if (cityInput.value) userInfoUpdates.city = cityInput.value;

          let updatesMade = false;

          // --- 2. Update auth.users if there are changes ---
          if (Object.keys(authUpdates).length > 0) {
            const { error: authError } = await supabase.auth.updateUser(authUpdates);
            if (authError) {
              alert(`Error updating profile: ${authError.message}`);
              return; // Stop if auth update fails
            }
            updatesMade = true;
          }

          // --- 3. Upsert user_info if there are changes ---
          if (Object.keys(userInfoUpdates).length > 0) {
            const { error: userInfoError } = await supabase
              .from('user_info')
              .upsert({
                user_uid: user.id, // Foreign key
                ...userInfoUpdates
              }, {
                onConflict: 'user_uid', // Specify the column to check for conflict
                ignoreDuplicates: false // Ensure it updates on conflict
              });

            if (userInfoError) {
              alert(`Error updating address info: ${userInfoError.message}`);
              return; // Stop if info update fails
            }
            updatesMade = true;
          }

          if (updatesMade) {
            alert('Profile updated successfully!');
            // Optionally, reload the profile to show the saved data
            loadUserProfile();
          } else {
            alert('No changes were entered.');
          }
        });
      }

      // --- Password Form Listener (New Structure) ---
      if (passwordForm) {
        passwordForm.addEventListener('submit', async (event) => {
          event.preventDefault();

          const newPassword = newPasswordInput.value;
          const confirmPassword = confirmPasswordInput.value;

          if (!newPassword) {
            alert('Please enter a new password.');
            return;
          }
          if (newPassword !== confirmPassword) {
            alert('New passwords do not match.');
            return;
          }

          const { error } = await supabase.auth.updateUser({ password: newPassword });

          if (error) {
            alert(`Error updating password: ${error.message}`);
          } else {
            alert('Password updated successfully!');
            passwordForm.reset();
          }
        });
      }

      // --- Delete Account Listener ---
      if (deleteButton) {
        deleteButton.addEventListener('click', handleDeleteAccount);
      }
    });

  </script>
</body>
</html>
