<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PCPick — PC Builder</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="assets/icon.ico">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- HEADER -->
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="index.html">
        <img src="assets/logo.png" alt="PCPick logo" class="logo-icon" width="36" height="36"/>
        <span class="logo-wordmark">
          <span class="logo-pc">PC</span><span class="logo-pick">PICK</span>
        </span>
      </a>

      <nav class="nav">
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="products.html" class="active">Products</a></li>
          <li><a href="pcbuilder.html">PC Builder</a></li>
          <li><a href="prebuiltpc.html">Pre-built PCs</a></li>
        </ul>
      </nav>

      <div class="nav-actions">
        <a class="login" data-auth-visible="signed-out" href="login.html">Log In</a>
        <a class="btn signup" data-auth-visible="signed-out" href="signup.html">Sign Up</a>

        <!-- Custom Icon Toggle -->
        <label class="theme-toggle">
          <input type="checkbox" id="theme-switch" />
          <span class="slider">
            <span class="sun"></span>
            <span class="moon"></span>
          </span>
        </label>
        <button class="menu-toggle" aria-label="Open menu" id="menu-toggle">&#9776;</button>
      </div>
    </div>
    <nav class="drawer-nav" id="mobile-drawer" aria-label="Mobile navigation" aria-hidden="true">
    <div class="drawer-header">
      <span class="drawer-brand">
        <img src="assets/logo.png" alt="PCPick logo" class="logo-icon" width="36" height="36" />
        <span class="logo-wordmark"><span class="logo-pc">PC</span><span class="logo-pick">PICK</span></span>
      </span>
      <button class="drawer-close" id="drawer-close" aria-label="Close menu">&times;</button>
    </div>
    <ul class="drawer-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="products.html">Products</a></li>
      <li><a href="pcbuilder.html">PC Builder</a></li>
      <li><a href="prebuiltpc.html">Pre-built PCs</a></li>
    </ul>
    <div class="drawer-actions">
      <a class="login" data-auth-visible="signed-out" href="login.html">Log In</a>
      <a class="btn signup" data-auth-visible="signed-out" href="signup.html">Sign Up</a>
    </div>
  </nav>
  <div class="drawer-overlay" id="drawer-overlay" hidden></div></header>

    <!-- PRODUCTS SECTION -->
  <main>
    <section class="container pcbuilder">
      <h1 class="section-title">PC Builder</h1>
      <p class="section-description">Browse components, customize and build your dream PC!</p>

      <!-- Category buttons -->
      <div class="products-controls">
        <div class="product-tabs" role="tablist" aria-label="product categories">
          <button class="tab active" data-cat="cpu-section">CPUs</button>
          <button class="tab" data-cat="gpu-section">Graphics Cards</button>
          <button class="tab" data-cat="memory-section">Memory (RAM)</button>
          <button class="tab" data-cat="motherboard-section">Motherboards</button>
          <button class="tab" data-cat="storage-section">Storage</button>
          <button class="tab" data-cat="psu-section">Power Supplies</button>
          <button class="tab" data-cat="case-section">Cases</button>
          <button class="tab" data-cat="cooler-section">Cooler</button>
        </div>
        <div class="product-search">
          <input type="search" placeholder="Search products..." aria-label="Search products">
        </div>
      </div>

      <!-- CPU PRODUCTS -->
      <div id="cpu-section" class="product-grid is-active">

        <div class="product-card">
          <img src="assets/Ryzen 7 7800X3D.jpg" alt="Ryzen 7 7800X3D">
          <div class="product-info">
            <h3>AMD Ryzen 7 7800X3D</h3>
            <ul>
              <li>8 Cores / 16 Threads</li>
              <li>5.0 GHz Boost</li>
              <li>3D V-Cache</li>
            </ul>
            <p class="price">$449</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>
      </div>

      <!-- GPU PRODUCTS -->
      <div id="gpu-section" class="product-grid">
        <div class="product-card">
          <img src="assets/rtx4090.jpg" alt="NVIDIA RTX 4090">
          <div class="product-info">
            <h3>NVIDIA RTX 4090</h3>
            <ul>
              <li>24GB GDDR6X</li>
              <li>16384 CUDA Cores</li>
              <li>450W TDP</li>
            </ul>
            <p class="price">$1599</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/rx7900xtx.jpg" alt="AMD RX 7900 XTX">
          <div class="product-info">
            <h3>AMD RX 7900 XTX</h3>
            <ul>
              <li>24GB GDDR6</li>
              <li>RDNA 3 Architecture</li>
              <li>355W TDP</li>
            </ul>
            <p class="price">$999</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/rtx4070ti.jpg" alt="NVIDIA RTX 4070 Ti">
          <div class="product-info">
            <h3>NVIDIA RTX 4070 Ti</h3>
            <ul>
              <li>12GB GDDR6X</li>
              <li>DLSS 3.0</li>
              <li>285W TDP</li>
            </ul>
            <p class="price">$799</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>
      </div>

      <!-- RAM PRODUCTS -->
      <div id="memory-section" class="product-grid">
        <div class="product-card">
          <img src="assets/vengeance-rgb-32gb.jpg" alt="Corsair Vengeance RGB 32GB">
          <div class="product-info">
            <h3>Corsair Vengeance RGB 32GB</h3>
            <ul>
              <li>DDR5-6000</li>
              <li>32GB (2x16GB)</li>
              <li>RGB Lighting</li>
            </ul>
            <p class="price">$129</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/trident-z5-64gb.jpg" alt="G.Skill Trident Z5 64GB">
          <div class="product-info">
            <h3>G.Skill Trident Z5 64GB</h3>
            <ul>
              <li>DDR5-6400</li>
              <li>64GB (2x32GB)</li>
              <li>Low Latency</li>
            </ul>
            <p class="price">$249</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/fury-beast-32gb.jpg" alt="Kingston Fury Beast 32GB">
          <div class="product-info">
            <h3>Kingston Fury Beast 32GB</h3>
            <ul>
              <li>DDR5-5200</li>
              <li>32GB (2x16GB)</li>
              <li>Budget Friendly</li>
            </ul>
            <p class="price">$99</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>
      </div>

      <!-- MOTHERBOARD PRODUCTS -->
      <div id="motherboard-section" class="product-grid">
        <div class="product-card">
          <img src="assets/rog-crosshair-x670e.jpg" alt="ASUS ROG Crosshair X670E">
          <div class="product-info">
            <h3>ASUS ROG Crosshair X670E</h3>
            <ul>
              <li>AM5 Socket</li>
              <li>PCIe 5.0</li>
              <li>WiFi 6E</li>
            </ul>
            <p class="price">$499</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/z790-aorus-master.jpg" alt="Gigabyte Z790 AORUS Master">
          <div class="product-info">
            <h3>Gigabyte Z790 AORUS Master Ultra Giga Pro</h3>
            <ul>
              <li>LGA1700 Socket</li>
              <li>DDR5</li>
              <li>Thunderbolt 4</li>
            </ul>
            <p class="price">$449</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/b650-gaming-plus.jpg" alt="MSI B650 Gaming Plus">
          <div class="product-info">
            <h3>MSI B650 Gaming Plus</h3>
            <ul>
              <li>AM5 Socket</li>
              <li>PCIe 4.0</li>
              <li>M.2 Heatsink</li>
            </ul>
            <p class="price">$199</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>
      </div>

      <!-- STORAGE PRODUCTS -->
      <div id="storage-section" class="product-grid">
        <div class="product-card">
          <img src="assets/990-pro-2tb.jpg" alt="Samsung 990 PRO 2TB">
          <div class="product-info">
            <h3>Samsung 990 PRO 2TB</h3>
            <ul>
              <li>NVMe Gen 4</li>
              <li>7450 MB/s Read</li>
              <li>2TB Capacity</li>
            </ul>
            <p class="price">$199</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/wd-black-sn850x.jpg" alt="Western Digital WD Black SN850X 1TB">
          <div class="product-info">
            <h3>Western Digital WD Black SN850X 1TB</h3>
            <ul>
              <li>NVMe Gen 4</li>
              <li>7300 MB/s Read</li>
              <li>1TB Capacity</li>
            </ul>
            <p class="price">$129</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/crucial-p3-plus-4tb.jpg" alt="Crucial P3 Plus 4TB">
          <div class="product-info">
            <h3>Crucial P3 Plus 4TB</h3>
            <ul>
              <li>NVMe Gen 4</li>
              <li>5000 MB/s Read</li>
              <li>4TB Capacity</li>
            </ul>
            <p class="price">$299</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>
      </div>

      <!-- PSU PRODUCTS -->
      <div id="psu-section" class="product-grid">
        <div class="product-card">
          <img src="assets/corsair-rm1000x.jpg" alt="Corsair RM1000x">
          <div class="product-info">
            <h3>Corsair RM1000x</h3>
            <ul>
              <li>1000W</li>
              <li>80+ Gold</li>
              <li>Fully Modular</li>
            </ul>
            <p class="price">$179</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/evga-supernova-850-g6.jpg" alt="EVGA SuperNOVA 850 G6">
          <div class="product-info">
            <h3>EVGA SuperNOVA 850 G6</h3>
            <ul>
              <li>850W</li>
              <li>80+ Gold</li>
              <li>Fully Modular</li>
            </ul>
            <p class="price">$139</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/seasonic-prime-tx-1600.jpg" alt="Seasonic PRIME TX-1600">
          <div class="product-info">
            <h3>Seasonic PRIME TX-1600</h3>
            <ul>
              <li>1600W</li>
              <li>80+ Titanium</li>
              <li>Fully Modular</li>
            </ul>
            <p class="price">$399</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>
      </div>

      <!-- CASE PRODUCTS -->
      <div id="case-section" class="product-grid">
        <div class="product-card">
          <img src="assets/corsair-5000d-airflow.webp" alt="Corsair 5000D Airflow">
          <div class="product-info">
            <h3>Corsair 5000D Airflow</h3>
            <ul>
              <li>Mid Tower</li>
              <li>Tempered Glass</li>
              <li>USB-C Front Panel</li>
            </ul>
            <p class="price">$164</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/nzxt-h7-flow.jpg" alt="NZXT H7 Flow">
          <div class="product-info">
            <h3>NZXT H7 Flow</h3>
            <ul>
              <li>Mid Tower</li>
              <li>Mesh Front</li>
              <li>Cable Management</li>
            </ul>
            <p class="price">$129</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/lian-li-o11-dynamic.jpg" alt="Lian Li O11 Dynamic">
          <div class="product-info">
            <h3>Lian Li O11 Dynamic</h3>
            <ul>
              <li>Mid Tower</li>
              <li>Dual Chamber</li>
              <li>Showcase Design</li>
            </ul>
            <p class="price">$159</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>
      </div>

      <!-- COOLER PRODUCTS -->
      <div id="cooler-section" class="product-grid">
        <div class="product-card">
          <img src="assets/nzxt-kraken-x73.webp" alt="NZXT Kraken X73">
          <div class="product-info">
            <h3>NZXT Kraken X73</h3>
            <ul>
              <li>360mm AIO</li>
              <li>RGB Pump</li>
              <li>Quiet Operation</li>
            </ul>
            <p class="price">$179</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/noctua-nh-d15-chromax.jpg" alt="Noctua NH-D15 chromax.black">
          <div class="product-info">
            <h3>Noctua NH-D15 chromax.black</h3>
            <ul>
              <li>Dual Tower</li>
              <li>Premium Fans</li>
              <li>Silent</li>
            </ul>
            <p class="price">$109</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/corsair-icue-h150i-elite.webp" alt="Corsair iCUE H150i Elite">
          <div class="product-info">
            <h3>Corsair iCUE H150i Elite</h3>
            <ul>
              <li>360mm AIO</li>
              <li>LCD Display</li>
              <li>RGB Fans</li>
            </ul>
            <p class="price">$189</p>
            <button class="add-cart-btn">Select</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <aside class="build-summary-panel" id="build-summary" aria-hidden="true">
    <div class="build-summary-inner">
      <header class="build-summary-header">
        <span class="build-summary-icon" aria-hidden="true">
          <img src="assets/cart.png" alt="">
        </span>
        <div>
          <p class="build-summary-label">Your Build</p>
          <p class="build-summary-note">Review selected components</p>
        </div>
      </header>
      <ul class="build-summary-list">
        <li data-summary-item="cpu">
          <span>CPU</span>
          <div class="summary-selection">
            <strong data-category="cpu">Not selected</strong>
            <span class="summary-price" data-price-category="cpu">—</span>
          </div>
          <button class="summary-clear" type="button" data-category="cpu" aria-label="Clear CPU selection">×</button>
        </li>
        <li data-summary-item="gpu">
          <span>GPU</span>
          <div class="summary-selection">
            <strong data-category="gpu">Not selected</strong>
            <span class="summary-price" data-price-category="gpu">—</span>
          </div>
          <button class="summary-clear" type="button" data-category="gpu" aria-label="Clear GPU selection">×</button>
        </li>
        <li data-summary-item="ram">
          <span>RAM</span>
          <div class="summary-selection">
            <strong data-category="ram">Not selected</strong>
            <span class="summary-price" data-price-category="ram">—</span>
          </div>
          <button class="summary-clear" type="button" data-category="ram" aria-label="Clear RAM selection">×</button>
        </li>
        <li data-summary-item="motherboard">
          <span>Motherboard</span>
          <div class="summary-selection">
            <strong data-category="motherboard">Not selected</strong>
            <span class="summary-price" data-price-category="motherboard">—</span>
          </div>
          <button class="summary-clear" type="button" data-category="motherboard" aria-label="Clear Motherboard selection">×</button>
        </li>
        <li data-summary-item="storage">
          <span>Storage</span>
          <div class="summary-selection">
            <strong data-category="storage">Not selected</strong>
            <span class="summary-price" data-price-category="storage">—</span>
          </div>
          <button class="summary-clear" type="button" data-category="storage" aria-label="Clear Storage selection">×</button>
        </li>
        <li data-summary-item="psu">
          <span>PSU</span>
          <div class="summary-selection">
            <strong data-category="psu">Not selected</strong>
            <span class="summary-price" data-price-category="psu">—</span>
          </div>
          <button class="summary-clear" type="button" data-category="psu" aria-label="Clear PSU selection">×</button>
        </li>
        <li data-summary-item="case">
          <span>Case</span>
          <div class="summary-selection">
            <strong data-category="case">Not selected</strong>
            <span class="summary-price" data-price-category="case">—</span>
          </div>
          <button class="summary-clear" type="button" data-category="case" aria-label="Clear Case selection">×</button>
        </li>
        <li data-summary-item="cooler">
          <span>Cooler</span>
          <div class="summary-selection">
            <strong data-category="cooler">Not selected</strong>
            <span class="summary-price" data-price-category="cooler">—</span>
          </div>
          <button class="summary-clear" type="button" data-category="cooler" aria-label="Clear Cooler selection">×</button>
        </li>
      </ul>
      <div class="build-summary-totals">
        <div class="summary-total-row">
          <span>Subtotal</span>
          <strong id="build-subtotal">$0.00</strong>
        </div>
        <div class="summary-total-row">
          <span>VAT (12%)</span>
          <strong id="build-vat">$0.00</strong>
        </div>
        <div class="summary-total-row summary-grand-total">
          <span>Total</span>
          <strong id="build-total">$0.00</strong>
        </div>
        <button class="btn checkout-btn" type="button">Checkout</button>
      </div>
    </div>
  </aside>

  <footer class="site-footer">
    <div class="container">
      <p>© 2025 PCPick — All rights reserved.</p>
    </div>
  </footer>

  <button
    type="button"
    class="build-toggle"
    id="build-toggle"
    aria-label="Toggle Your Build summary"
    aria-controls="build-summary"
    aria-expanded="false"
  >
    <span class="build-toggle-left">
      <span class="build-toggle-cart" aria-hidden="true"><img src="assets/cart.png" alt="" loading="lazy"></span>
      <span class="build-toggle-text">
        <span class="build-toggle-title">Build</span>
        <span class="build-toggle-count">(0/8)</span>
      </span>
    </span>
    <span class="build-toggle-chevron" aria-hidden="true"></span>
  </button>

  <div class="build-toast" id="build-toast" role="status" aria-live="polite" aria-hidden="true"></div>

  <script src="script.js"></script>
  <!-- Supabase client (UMD) and data loader -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="supabase-data.js"></script>
  <script>
    // Ensure price and select button share a row
    const ensurePurchaseRow = () => {
      document.querySelectorAll('.pcbuilder .product-card').forEach((card) => {
        const info = card.querySelector('.product-info');
        const price = info?.querySelector('.price');
        const button = info?.querySelector('.add-cart-btn');
        if (!info || !price || !button || button.closest('.purchase-row')) return;
        const row = document.createElement('div');
        row.className = 'purchase-row';
        row.appendChild(price);
        row.appendChild(button);
        info.appendChild(row);
      });
    };
    ensurePurchaseRow();

    const builderTabs = document.querySelectorAll(".pcbuilder .product-tabs .tab");
    const builderSections = document.querySelectorAll(".pcbuilder .product-grid");

    if (builderTabs.length && builderSections.length) {
      const showSection = (targetId) => {
        builderSections.forEach((section) => {
          section.style.display = section.id === targetId ? "grid" : "none";
        });
      };

      builderTabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          builderTabs.forEach((btn) => btn.classList.remove("active"));
          tab.classList.add("active");
          showSection(tab.dataset.cat);
        });
      });

      showSection(builderTabs[0]?.dataset.cat ?? builderSections[0]?.id);
    }

    const buildToggle = document.getElementById("build-toggle");
    const buildSummary = document.getElementById("build-summary");

    if (buildToggle && buildSummary) {
      buildToggle.addEventListener("click", () => {
        const expanded = buildToggle.getAttribute("aria-expanded") === "true";
        const nextState = !expanded;

        buildToggle.setAttribute("aria-expanded", String(nextState));
        buildSummary.classList.toggle("is-visible", nextState);
        buildSummary.setAttribute("aria-hidden", expanded ? "true" : "false");
      });

      // Minimize summary when clicking on the page background (not on controls)
      const collapseSummary = () => {
        buildToggle.setAttribute("aria-expanded", "false");
        buildSummary.classList.remove("is-visible");
        buildSummary.setAttribute("aria-hidden", "true");
      };

      document.addEventListener("click", (e) => {
        // Ignore if click is inside the summary or on the toggle button
        if (e.target.closest("#build-summary") || e.target.closest("#build-toggle")) return;

        // Ignore clicks anywhere in the site header
        if (e.target.closest('.site-header')) return;

        // Ignore if clicking interactive controls (buttons/links/inputs/selects/textareas)
        if (e.target.closest("button, a, input, textarea, select, [role='button'], [contenteditable=''], [contenteditable='true']")) return;

        // If summary is open, collapse it
        const expanded = buildToggle.getAttribute("aria-expanded") === "true";
        if (expanded) collapseSummary();
      });
    }

    const summaryMap = {};
    document.querySelectorAll(".build-summary-list strong[data-category]").forEach((entry) => {
      summaryMap[entry.dataset.category] = entry;
    });
    const summaryPriceMap = {};
    document.querySelectorAll(".summary-price[data-price-category]").forEach((entry) => {
      summaryPriceMap[entry.dataset.priceCategory] = entry;
    });
    const summaryItems = {};
    document.querySelectorAll(".build-summary-list li[data-summary-item]").forEach((item) => {
      summaryItems[item.dataset.summaryItem] = item;
    });
    const clearButtons = {};
    document.querySelectorAll(".summary-clear[data-category]").forEach((btn) => {
      clearButtons[btn.dataset.category] = btn;
    });
    const selectedCards = {};
    const selectedPrices = {};
    const buildCountEl = document.querySelector(".build-toggle-count");
    const subtotalEl = document.getElementById("build-subtotal");
    const vatEl = document.getElementById("build-vat");
    const totalEl = document.getElementById("build-total");
    const toast = document.getElementById("build-toast");
    let toastTimeout;
    const VAT_RATE = 0.12;
    const currencyFormatter = new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: "USD",
      minimumFractionDigits: 2,
    });

    const sectionCategoryMap = {
      "cpu-section": "cpu",
      "gpu-section": "gpu",
      "memory-section": "ram",
      "motherboard-section": "motherboard",
      "storage-section": "storage",
      "psu-section": "psu",
      "case-section": "case",
      "cooler-section": "cooler",
    };

    function updateBuildCount() {
      const total = Object.keys(summaryMap).length;
      const filled = Object.values(summaryMap).filter(
        (entry) => entry.textContent.trim().toLowerCase() !== "not selected"
      ).length;
      if (buildCountEl) {
        buildCountEl.textContent = `(${filled}/${total})`;
      }
    }

    function parsePrice(value) {
      if (!value) return 0;
      const numeric = Number(value.replace(/[^0-9.]/g, ""));
      return Number.isFinite(numeric) ? numeric : 0;
    }

    function formatCurrency(value) {
      return currencyFormatter.format(value);
    }

    function updateTotals() {
      const subtotal = Object.values(selectedPrices).reduce((sum, price) => sum + price, 0);
      const vat = subtotal * VAT_RATE;
      const total = subtotal + vat;

      if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);
      if (vatEl) vatEl.textContent = formatCurrency(vat);
      if (totalEl) totalEl.textContent = formatCurrency(total);
    }

    function showToast(message) {
      if (!toast) return;
      toast.textContent = message;
      toast.setAttribute("aria-hidden", "false");
      toast.classList.add("is-visible");
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        toast?.classList.remove("is-visible");
        toast?.setAttribute("aria-hidden", "true");
      }, 2200);
    }

    function setSelectedCard(categoryKey, card, productName, priceValue) {
      if (!categoryKey || !card) return;

      const previous = selectedCards[categoryKey];
      const prevUid = previous?.dataset?.uid || null;
      if (previous && previous !== card) {
        previous.classList.remove("is-selected");
        const prevButton = previous.querySelector(".add-cart-btn");
        if (prevButton) {
          prevButton.classList.remove("is-selected");
          prevButton.textContent = "Select";
        }
      }

      const button = card.querySelector(".add-cart-btn");
      card.classList.add("is-selected");
      if (button) {
        button.classList.add("is-selected");
        button.textContent = "Selected";
      }
      summaryMap[categoryKey].textContent = productName;
      summaryMap[categoryKey].classList.add("has-selection");
      if (summaryPriceMap[categoryKey]) {
        summaryPriceMap[categoryKey].textContent = formatCurrency(priceValue);
      }
      if (summaryItems[categoryKey]) {
        summaryItems[categoryKey].classList.add("has-selection");
      }
      selectedCards[categoryKey] = card;
      selectedPrices[categoryKey] = priceValue;
      // Persist to user_build: replace previous selection with new
      try {
        const uid = card?.dataset?.uid || null;
        if (uid) window.pcpickBuildReplace?.({ prev_uid: prevUid, new_uid: uid, price: priceValue });
      } catch {}
    }

    const wireNewBuilderButtons = () => {
      document.querySelectorAll(".pcbuilder .add-cart-btn").forEach((button) => {
        if (button.dataset.pcpickWired === '1') return;
        button.dataset.pcpickWired = '1';
        button.addEventListener("click", async () => {
          const card = button.closest(".product-card");
          const section = button.closest(".product-grid");
          const productName =
            card?.querySelector(".product-info h3")?.textContent?.trim() || "Item";
          const priceText = card?.querySelector(".price")?.textContent?.trim() || "$0";
          const priceValue = parsePrice(priceText);
          const categoryKey = sectionCategoryMap[section?.id ?? ""];

          if (!categoryKey || !summaryMap[categoryKey]) {
            showToast(`${productName} added to your cart.`);
            return;
          }

          await setSelectedCard(categoryKey, card, productName, priceValue);
          showToast(`${productName} added to Your Build!`);
          updateBuildCount();
          updateTotals();
        });
      });
    };
    wireNewBuilderButtons();
    document.addEventListener('pcpick:builder-populated', () => {
      ensurePurchaseRow();
      wireNewBuilderButtons();
    });
    document.addEventListener('pcpick:builder-populated', wireNewBuilderButtons);
    wireNewBuilderButtons(); // Wire buttons for any static content on initial load

    // Restore build selections from server snapshot
    const applyBuildSnapshot = (rows=[]) => {
      try {
        rows.forEach((r) => {
          if (!r || !r.uid) return;
          const card = document.querySelector(`.pcbuilder .product-card[data-uid="${r.uid}"]`);
          if (!card) return;
          const section = card.closest('.product-grid');
          const categoryKey = sectionCategoryMap[section?.id ?? ""];
          const productName = card.querySelector('.product-info h3')?.textContent?.trim() || r.name || 'Item';
          const unit = parsePrice(card.querySelector('.price')?.textContent?.trim() || '') || r.price || 0;
          if (categoryKey) setSelectedCard(categoryKey, card, productName, unit);
        });
        updateBuildCount();
        updateTotals();
      } catch {}
    };
    document.addEventListener('pcpick:build-snapshot', (e) => applyBuildSnapshot(e.detail?.rows || []));
    window.pcpickGetBuildSnapshot?.().then(applyBuildSnapshot);

    Object.values(clearButtons).forEach((button) => {
      button.addEventListener("click", () => {
        const categoryKey = button.dataset.category;
        if (!categoryKey || !summaryMap[categoryKey]) return;

        const card = selectedCards[categoryKey];
        if (card) {
          card.classList.remove("is-selected");
          const btn = card.querySelector(".add-cart-btn");
          if (btn) {
            btn.classList.remove("is-selected");
            btn.textContent = "Select";
          }
          delete selectedCards[categoryKey];
        }

        summaryMap[categoryKey].textContent = "Not selected";
        summaryMap[categoryKey].classList.remove("has-selection");
        if (summaryPriceMap[categoryKey]) {
          summaryPriceMap[categoryKey].textContent = "—";
        }
        if (summaryItems[categoryKey]) {
          summaryItems[categoryKey].classList.remove("has-selection");
        }
        const uid = card?.dataset?.uid || null;
        delete selectedPrices[categoryKey];
        updateBuildCount();
        updateTotals();
        try { if (uid) window.pcpickBuildDelete?.({ product_uid: uid }); } catch {}
      });
    });
  </script>
</body>
</html>









