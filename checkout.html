<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Checkout — PCPick</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="assets/icon.ico">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- ===== HEADER ===== -->
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="index.html">
        <img src="assets/logo.png" alt="PCPick logo" class="logo-icon"/>
        <span class="logo-wordmark" aria-hidden>
          <span class="logo-pc">PC</span><span class="logo-pick">PICK</span>
        </span>
      </a>

      <nav class="nav" id="main-nav">
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="products.html">Products</a></li>
          <li><a href="pcbuilder.html">PC Builder</a></li>
          <li><a href="prebuiltpc.html">Pre-built PCs</a></li>
        </ul>
      </nav>

      <div class="nav-actions">
        <a class="login" data-auth-visible="signed-out" href="login.html">Log In</a>
        <a class="btn signup" data-auth-visible="signed-out" href="signup.html">Sign Up</a>

        <label class="theme-toggle">
          <input type="checkbox" id="theme-switch" />
          <span class="slider">
            <span class="sun"></span>
            <span class="moon"></span>
          </span>
        </label>

        <button class="menu-toggle" aria-label="Open menu" id="menu-toggle">&#9776;</button>
      </div>
    </div>

    <nav class="drawer-nav" id="mobile-drawer" aria-label="Mobile navigation" aria-hidden="true">
      <div class="drawer-header">
        <span class="drawer-brand">
          <img src="assets/logo.png" alt="PCPick logo" class="logo-icon" width="36" height="36" />
          <span class="logo-wordmark"><span class="logo-pc">PC</span><span class="logo-pick">PICK</span></span>
        </span>
        <button class="drawer-close" id="drawer-close" aria-label="Close menu">&times;</button>
      </div>
      <ul class="drawer-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="products.html">Products</a></li>
        <li><a href="pcbuilder.html">PC Builder</a></li>
        <li><a href="prebuiltpc.html">Pre-built PCs</a></li>
      </ul>
      <div class="drawer-actions">
        <a class="login" data-auth-visible="signed-out" href="login.html">Log In</a>
        <a class="btn signup" data-auth-visible="signed-out" href="signup.html">Sign Up</a>
      </div>
    </nav>
    <div class="drawer-overlay" id="drawer-overlay" hidden></div>
  </header>

  <!-- ===== MAIN CHECKOUT CONTENT ===== -->
  <main class="checkout-container">
    <div class="container">
      <a href="pcbuilder.html" class="back-link">← Back to Builder</a>

      <h1 class="checkout-title">Checkout</h1>

      <div class="checkout-layout">
        <!-- ===== LEFT COLUMN: FORM ===== -->
        <div class="checkout-form">
          <!-- Billing Information -->
          <section class="checkout-section">
            <h2>Billing Information</h2>
            <div class="form-grid two-col">
              <div>
                <label>First Name</label>
                <input type="text" placeholder="John">
              </div>
              <div>
                <label>Last Name</label>
                <input type="text" placeholder="Doe">
              </div>
            </div>
            <div class="form-grid">
              <label>Email Address</label>
              <input type="email" placeholder="johndoe@email.com">
            </div>
            <div class="form-grid">
              <label>Phone Number</label>
              <input type="text" placeholder="+63 900 000 0000">
            </div>
          </section>

          <!-- Shipping Information -->
          <section class="checkout-section">
            <h2>Shipping Address</h2>
            <div class="form-grid">
              <label>Address Line</label>
              <input type="text" placeholder="123 Main Street">
            </div>
            <div class="form-grid two-col">
              <div>
                <label>City</label>
                <input type="text" placeholder="Manila">
              </div>
              <div>
                <label>Postal Code</label>
                <input type="text" placeholder="1000">
              </div>
            </div>
            <div class="form-grid">
              <label>Country</label>
              <input type="text" placeholder="Philippines">
            </div>
          </section>

          <!-- Payment Method -->
          <section class="checkout-section">
            <h2>Payment Method</h2>
            <div class="form-grid">
              <label><input type="radio" name="payment" checked> Credit / Debit Card</label>
              <label><input type="radio" name="payment"> Cash on Delivery</label>
            </div>
            <div class="form-grid two-col">
              <div>
                <label>Card Number</label>
                <input type="text" placeholder="1234 5678 9012 3456">
              </div>
              <div>
                <label>Expiry</label>
                <input type="text" placeholder="MM/YY">
              </div>
            </div>
            <div class="form-grid">
              <label>CVV</label>
              <input type="text" placeholder="123">
            </div>
            <button class="btn-place" id="place-order-btn">Place Order</button>
          </section>
        </div>

        <!-- ===== RIGHT COLUMN: SUMMARY ===== -->
        <aside class="checkout-summary order-summary">
          <h2>Order Summary</h2>

          <!-- This is where the script will add your cart items -->
          <ul id="order-summary-list" class="order-summary-list"></ul>

          <div class="build-summary-totals">
            <div class="summary-total-row">
              <span>Subtotal</span>
              <strong id="summary-subtotal" data-summary="subtotal">₱0.00</strong>
            </div>
            <div class="summary-total-row">
              <span>VAT (12%)</span>
              <strong id="summary-vat" data-summary="vat">₱0.00</strong>
            </div>
            <hr class="summary-divider">
            <div class="summary-total-row summary-grand-total">
              <span>Total</span>
              <strong id="summary-total" data-summary="total">₱0.00</strong>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>

          <!-- real-time items list (script looks for .order-items and #order-summary-list) -->
          <ul id="order-summary-list" class="order-items order-summary-list"></ul>

          <div class="summary-totals summary-totals">
            <div class="summary-row" data-summary-row="subtotal">
              <span>Subtotal</span>
              <strong id="summary-subtotal" data-summary="subtotal">₱0.00</strong>
            </div>
            <div class="summary-row" data-summary-row="vat">
              <span>VAT (12%)</span>
              <strong id="summary-vat" data-summary="vat">₱0.00</strong>
            </div>
            <div class="summary-row total" data-summary-row="total">
              <span>Total</span>
              <strong id="summary-total" data-summary="total">₱0.00</strong>
            </div>
          </div>
        </aside>

  </main>
  <!-- ===== FOOTER ===== -->
  <footer class="site-footer">
    <div class="container">
      <p>&copy; <span id="year"></span> PCPick — All rights reserved.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="supabase-data.js"></script>
  <script src="script.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const placeOrderBtn = document.getElementById('place-order-btn');
      const form = document.querySelector('.checkout-form');

      if (!placeOrderBtn || !form) return;

      placeOrderBtn.addEventListener('click', async (e) => {
        e.preventDefault();

        // 1. Validate form inputs
        const inputs = form.querySelectorAll('input[type="text"], input[type="email"]');
        let allFieldsFilled = true;
        inputs.forEach(input => {
          if (!input.value.trim()) {
            allFieldsFilled = false;
            input.style.borderColor = 'red'; // Highlight empty fields
          } else {
            input.style.borderColor = ''; // Reset border color
          }
        });

        if (!allFieldsFilled) {
          alert('Please fill out all required fields.');
          return;
        }

        placeOrderBtn.disabled = true;
        placeOrderBtn.textContent = 'Placing Order...';

        // 2. Gather form data (example structure)
        const orderDetails = {
          billing: {
            firstName: form.querySelector('input[placeholder="John"]').value,
            lastName: form.querySelector('input[placeholder="Doe"]').value,
            email: form.querySelector('input[placeholder="johndoe@email.com"]').value,
            phone: form.querySelector('input[placeholder*="+63"]').value,
          },
          shipping: {
            address: form.querySelector('input[placeholder*="Main Street"]').value,
            city: form.querySelector('input[placeholder="Manila"]').value,
            postalCode: form.querySelector('input[placeholder="1000"]').value,
            country: form.querySelector('input[placeholder="Philippines"]').value,
          }
        };

        // 3. Call the placeOrder function
        const { order, error } = await window.pcpickPlaceOrder(orderDetails);

        if (error) {
          alert(`Order failed: ${error.message}`);
          placeOrderBtn.disabled = false;
          placeOrderBtn.textContent = 'Place Order';
        } else {
          alert(`Order #${order.id} placed successfully!`);
          window.location.href = 'orders.html'; // Redirect to orders page
        }
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Fetch the cart data from Supabase when the page loads
      if (window.pcpickLoadUserCartForCheckout) {
        window.pcpickLoadUserCartForCheckout();
      }
    });

    // Listen for the cart data and render the order summary
    document.addEventListener("pcpick:checkout-cart", (e) => {
      const rows = e.detail.rows || [];
      
      const list = document.getElementById("order-summary-list");
      const subtotalEl = document.getElementById("summary-subtotal");
      const vatEl = document.getElementById("summary-vat");
      const totalEl = document.getElementById("summary-total");

      if (!list || !subtotalEl || !vatEl || !totalEl) return;

      list.innerHTML = ""; // Clear previous items

      let subtotal = 0;
      const fmt = new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' });

      rows.forEach(item => {
        const li = document.createElement("li");
        li.className = "summary-item";
        const price = Number(item.price || 0);
        const qty = Number(item.quantity || 1);
        const lineTotal = price * qty;

        subtotal += lineTotal;

        li.innerHTML = `
          <span>${item.name || item.product_name} (x${qty})</span>
          <strong>${fmt.format(lineTotal)}</strong>
        `;
        list.appendChild(li);
      });

      const vat = subtotal * 0.12;
      const total = subtotal + vat;

      // Update totals in the summary
      subtotalEl.textContent = fmt.format(subtotal);
      vatEl.textContent = fmt.format(vat);
      totalEl.textContent = fmt.format(total);
    });
  </script>

  
</body>
</html>
