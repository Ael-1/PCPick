<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PCPick — Pre-built PCs</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="assets/icon.ico">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- HEADER -->
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="index.html">
        <img src="assets/logo.png" alt="PCPick logo" class="logo-icon" width="36" height="36"/>
        <span class="logo-wordmark">
          <span class="logo-pc">PC</span><span class="logo-pick">PICK</span>
        </span>
      </a>

      <nav class="nav">
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="products.html" class="active">Products</a></li>
          <li><a href="pcbuilder.html">PC Builder</a></li>
          <li><a href="prebuiltpc.html">Pre-built PCs</a></li>
        </ul>
      </nav>

      <div class="nav-actions">
        <a class="login" data-auth-visible="signed-out" href="login.html">Log In</a>
        <a class="btn signup" data-auth-visible="signed-out" href="signup.html">Sign Up</a>

        <!-- Custom Icon Toggle -->
        <label class="theme-toggle">
          <input type="checkbox" id="theme-switch" />
          <span class="slider">
            <span class="sun"></span>
            <span class="moon"></span>
          </span>
        </label>
        <button class="menu-toggle" aria-label="Open menu" id="menu-toggle">&#9776;</button>
      </div>
    </div>
    <nav class="drawer-nav" id="mobile-drawer" aria-label="Mobile navigation" aria-hidden="true">
    <div class="drawer-header">
      <span class="drawer-brand">
        <img src="assets/logo.png" alt="PCPick logo" class="logo-icon" width="36" height="36" />
        <span class="logo-wordmark"><span class="logo-pc">PC</span><span class="logo-pick">PICK</span></span>
      </span>
      <button class="drawer-close" id="drawer-close" aria-label="Close menu">&times;</button>
    </div>
    <ul class="drawer-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="products.html">Products</a></li>
      <li><a href="pcbuilder.html">PC Builder</a></li>
      <li><a href="prebuiltpc.html">Pre-built PCs</a></li>
    </ul>
    <div class="drawer-actions">
      <a class="login" data-auth-visible="signed-out" href="login.html">Log In</a>
      <a class="btn signup" data-auth-visible="signed-out" href="signup.html">Sign Up</a>
    </div>
  </nav>
  <div class="drawer-overlay" id="drawer-overlay" hidden></div></header>

  <!-- PRODUCTS SECTION -->
  <main>
    <section class="container prebuiltpcs">
      <h2 class="section-title">Pre-built PCs</h2>
      <p class="section-description">Browse brand new and expertly configured systems. No hassle!</p>

      <div class="product-search">
        <input class="product-search-input" 
        type="search" 
        placeholder="Search products..." 
        aria-label="Search products">
      </div>

      <!-- CPU PRODUCTS -->
       <div id="prebuilt-section" class="product-grid"></div>
      <div id="cpu-section" class="product-grid">
        <div class="product-card">
          <img src="assets/Ryzen9_7950X.jpg" alt="Ryzen 9 7950X">
          <div class="product-info">
            <h3>AMD Ryzen 9 7950X</h3>
            <ul>
              <li>16 Cores / 32 Threads</li>
              <li>5.7 GHz Boost</li>
              <li>AM5 Socket</li>
            </ul>
            <p class="price">PHP 549</p>
            <button class="add-cart-btn">Add to Cart</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/Core i9-14900K.png" alt="Intel Core i9-14900K">
          <div class="product-info">
            <h3>Intel Core i9-14900K</h3>
            <ul>
              <li>24 Cores / 32 Threads</li>
              <li>6.0 GHz Boost</li>
              <li>LGA1700 Socket</li>
            </ul>
            <p class="price">PHP 589</p>
            <button class="add-cart-btn">Add to Cart</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/Ryzen 7 7800X3D.jpg" alt="Ryzen 7 7800X3D">
          <div class="product-info">
            <h3>AMD Ryzen 7 7800X3D</h3>
            <ul>
              <li>8 Cores / 16 Threads</li>
              <li>5.0 GHz Boost</li>
              <li>3D V-Cache</li>
            </ul>
            <p class="price">PHP 449</p>
            <button class="add-cart-btn">Add to Cart</button>
          </div>
        </div>
      </div>

      <!-- GPU PRODUCTS -->
      <div id="gpu-section" class="product-grid">
        <div class="product-card">
          <img src="assets/rtx4090.jpg" alt="NVIDIA RTX 4090">
          <div class="product-info">
            <h3>NVIDIA RTX 4090</h3>
            <ul>
              <li>24GB GDDR6X</li>
              <li>16384 CUDA Cores</li>
              <li>450W TDP</li>
            </ul>
            <p class="price">PHP 1599</p>
            <button class="add-cart-btn">Add to Cart</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/rx7900xtx.jpg" alt="AMD RX 7900 XTX">
          <div class="product-info">
            <h3>AMD RX 7900 XTX</h3>
            <ul>
              <li>24GB GDDR6</li>
              <li>RDNA 3 Architecture</li>
              <li>355W TDP</li>
            </ul>
            <p class="price">PHP 999</p>
            <button class="add-cart-btn">Add to Cart</button>
          </div>
        </div>

        <div class="product-card">
          <img src="assets/rtx4070ti.jpg" alt="NVIDIA RTX 4070 Ti">
          <div class="product-info">
            <h3>NVIDIA RTX 4070 Ti</h3>
            <ul>
              <li>12GB GDDR6X</li>
              <li>DLSS 3.0</li>
              <li>285W TDP</li>
            </ul>
            <p class="price">PHP 799</p>
            <button class="add-cart-btn">Add to Cart</button>
          </div>
        </div>
      </div>
    </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>© 2025 PCPick — All rights reserved.</p>
    </div>
  </footer>

  <!-- Cart summary (same as products) -->
  <aside class="build-summary-panel" id="cart-summary" aria-hidden="true">
    <div class="build-summary-inner">
      <header class="build-summary-header">
        <span class="build-summary-icon" aria-hidden="true">
          <img src="assets/cart.png" alt="">
        </span>
        <div>
          <p class="build-summary-label">Your Cart</p>
          <p class="build-summary-note">Items added to your cart</p>
        </div>
      </header>
      <ul class="build-summary-list" id="cart-list"></ul>
      <p class="build-summary-note" id="cart-empty">Your cart is empty. Add an item to see it here.</p>
      <div class="build-summary-totals" id="cart-totals" hidden>
        <div class="summary-total-row">
          <span>Subtotal</span>
          <strong id="cart-subtotal">PHP 0.00</strong>
        </div>
        <div class="summary-total-row">
          <span>VAT (12%)</span>
          <strong id="cart-vat">PHP 0.00</strong>
        </div>
        <div class="summary-total-row summary-grand-total">
          <span>Total</span>
          <strong id="cart-total">PHP 0.00</strong>
        </div>
        <button class="btn checkout-btn" type="button">Checkout</button>
      </div>
    </div>
  </aside>

  <button
    type="button"
    class="build-toggle"
    id="cart-toggle"
    aria-label="Toggle cart summary"
    aria-controls="cart-summary"
    aria-expanded="false"
  >
    <span class="build-toggle-left">
      <span class="build-toggle-cart" aria-hidden="true"><img src="assets/cart.png" alt="" loading="lazy"></span>
      <span class="build-toggle-text">
        <span class="build-toggle-title">Cart</span>
        <span class="build-toggle-count" id="cart-count">(0)</span>
      </span>
    </span>
    <span class="build-toggle-chevron" aria-hidden="true"></span>
  </button>

  <div class="build-toast" id="product-toast" role="status" aria-live="polite" aria-hidden="true"></div>

  <script src="script.js"></script>
  <!-- Supabase client (UMD) and data loader -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="supabase-data.js"></script>
  <script>
    (function(){
      const cartToggle = document.getElementById('cart-toggle');
      const cartSummary = document.getElementById('cart-summary');
      const cartList = document.getElementById('cart-list');
      const cartCount = document.getElementById('cart-count');
      const cartTotals = document.getElementById('cart-totals');
      const cartSubtotalEl = document.getElementById('cart-subtotal');
      const cartVatEl = document.getElementById('cart-vat');
      const cartTotalEl = document.getElementById('cart-total');
      const cartEmpty = document.getElementById('cart-empty');
      const toast = document.getElementById('product-toast');

      const fmt = new Intl.NumberFormat('en-PH',{style:'currency',currency:'PHP',minimumFractionDigits:2});
      const parsePrice = (t)=>{const n=Number((t||'').replace(/[^0-9.]/g,''));return Number.isFinite(n)?n:0};

      const cartItems = new Map();
      const selectedQuantities = new Map();

      const VAT_RATE = 0.12;
      const renderTotals = () => {
        const qtyTotal = Array.from(cartItems.values()).reduce((s,i)=>s+i.qty,0);
        const subtotal = Array.from(cartItems.values()).reduce((s,i)=>s + (i.unit*i.qty),0);
        const vat = subtotal * VAT_RATE;
        const total = subtotal + vat;
        cartCount.textContent = `(${qtyTotal})`;
        if (cartEmpty) cartEmpty.hidden = qtyTotal > 0 ? true : false;
        if (cartTotals) {
          cartTotals.hidden = qtyTotal === 0;
          if (cartSubtotalEl) cartSubtotalEl.textContent = fmt.format(subtotal);
          if (cartVatEl) cartVatEl.textContent = fmt.format(vat);
          if (cartTotalEl) cartTotalEl.textContent = fmt.format(total);
        }
      };

      const productKey = (name, unit)=>`${name}|${unit}`;

      const updateCartRowQty = (key) => {
        const row = cartList?.querySelector(`li[data-key="${key}"]`);
        if (!row) return;
        const q = cartItems.get(key)?.qty ?? 0;
        const input = row.querySelector('.cart-qty-input');
        if (input) input.value = String(Math.max(1, q));
      };

      const ensureCartRow = (key, name, unit, uid) => {
        let row = cartList?.querySelector(`li[data-key="${key}"]`);
        if (row) return row;
        row = document.createElement('li');
        row.classList.add('has-selection');
        row.dataset.key = key;
        if (uid) row.dataset.uid = uid;
        row.innerHTML = `
          <span>Item</span>
          <div class="summary-selection">
            <strong class="has-selection">${name}</strong>
            <span class="summary-price">${fmt.format(unit)}</span>
          </div>
          <div class="cart-qty-controls">
            <button type="button" class="cart-qty-minus" aria-label="Decrease quantity">-</button>
            <input type="number" class="cart-qty-input" aria-label="Quantity" value="1" min="1" inputmode="numeric">
            <button type="button" class="cart-qty-plus" aria-label="Increase quantity">+</button>
          </div>
          <button class="summary-clear" type="button" aria-label="Remove from cart">x</button>`;
        cartList?.appendChild(row);
        row.querySelector('.summary-clear')?.addEventListener('click', ()=>{
          cartItems.delete(key);
          row.remove();
          renderTotals();
        });

        const qtyInput = row.querySelector('.cart-qty-input');

        row.querySelector('.cart-qty-plus')?.addEventListener('click', ()=>{
          adjustCartQuantity(name, unit, 1);
        });

        row.querySelector('.cart-qty-minus')?.addEventListener('click', ()=>{
          adjustCartQuantity(name, unit, -1);
        });

        qtyInput?.addEventListener('input', () => {
          const value = Math.max(1, Math.floor(Number(qtyInput.value) || 1));
          qtyInput.value = String(value);
          const key = productKey(name, unit);
          const current = cartItems.get(key);
          if (!current) return;
          const delta = value - current.qty;
          if (delta !== 0) {
            adjustCartQuantity(name, unit, delta);
          }
        });
        return row;
      };

      const adjustCartQuantity = (name, unit, delta, uid) => {
        if (!delta) return;
        const key = productKey(name, unit);
        const current = cartItems.get(key) || { name, unit, qty: 0, uid };
        if (uid && !current.uid) current.uid = uid;
        current.qty = Math.max(0, current.qty + delta);
        if (current.qty === 0) {
          cartItems.delete(key);
          cartList?.querySelector(`li[data-key="${key}"]`)?.remove();
          try { if (current.uid) window.pcpickCartSet?.({ product_uid: current.uid, price: current.unit, quantity: 0 }); } catch {}
        } else {
          cartItems.set(key, current);
          ensureCartRow(key, name, unit, current.uid);
          updateCartRowQty(key);
          try { if (current.uid) window.pcpickCartSet?.({ product_uid: current.uid, price: current.unit, quantity: current.qty }); } catch {}
        }
        renderTotals();
      };

      const showToast = (msg) => {
        if (!toast) return;
        toast.textContent = msg;
        toast.setAttribute('aria-hidden','false');
        toast.classList.add('is-visible');
        clearTimeout(showToast.tid);
        showToast.tid = setTimeout(()=>{
          toast.classList.remove('is-visible');
          toast.setAttribute('aria-hidden','true');
        }, 2000);
      };

      const collapseCart = () => {
        cartToggle?.setAttribute('aria-expanded','false');
        cartSummary?.classList.remove('is-visible');
        cartSummary?.setAttribute('aria-hidden','true');
      };

      cartToggle?.addEventListener('click', ()=>{
        const expanded = cartToggle.getAttribute('aria-expanded') === 'true';
        const next = !expanded;
        cartToggle.setAttribute('aria-expanded', String(next));
        cartSummary.classList.toggle('is-visible', next);
        cartSummary.setAttribute('aria-hidden', expanded ? 'true' : 'false');
      });

      document.addEventListener('click', (event) => {
        if (!cartSummary || !cartToggle) return;
        if (event.target.closest('#cart-summary') || event.target.closest('#cart-toggle')) return;
        if (event.target.closest('.site-header')) return;
        if (event.target.closest('button, a, input, textarea, select, [role="button"], [contenteditable=""], [contenteditable="true"]')) return;
        if (cartToggle.getAttribute('aria-expanded') === 'true') {
          collapseCart();
        }
      });

      // Inject quantity controls and wire events for any new buttons
      const wireNewAddToCartButtons = () => {
        document.querySelectorAll('.add-cart-btn').forEach(btn=>{
          if (btn.dataset.pcpickWired === '1') return;
          btn.dataset.pcpickWired = '1';
          const card = btn.closest('.product-card');
          if (!card) return;
        const row = document.createElement('div');
        row.className = 'add-cart-row';
        const qc = document.createElement('div');
        qc.className = 'qty-controls';
        qc.innerHTML = `<button type="button" class="qty-minus" aria-label="Decrease quantity">-</button>
                        <input type="number" class="qty-amount" value="0" min="0" inputmode="numeric" aria-label="Quantity">
                        <button type="button" class="qty-plus" aria-label="Increase quantity">+</button>`;
        row.appendChild(qc);
        row.appendChild(btn);

        const info = card.querySelector('.product-info');
        const price = card.querySelector('.price');
        const purchaseRow = document.createElement('div');
        purchaseRow.className = 'purchase-row';
        if (price) purchaseRow.appendChild(price);
        purchaseRow.appendChild(row);
        info?.appendChild(purchaseRow);

        const getData = () => {
          const name = card.querySelector('.product-info h3')?.textContent?.trim() || 'Item';
          const unit = parsePrice(card.querySelector('.price')?.textContent?.trim() || 'PHP 0');
          const uid = card?.dataset?.uid || null;
          return { name, unit, uid };
        };

        const amountInput = qc.querySelector('.qty-amount');

        const updateSelection = (key, next) => {
          const value = Math.max(0, next);
          selectedQuantities.set(key, value);
          if (amountInput) amountInput.value = String(value);
        };

        btn.addEventListener('click', ()=>{
          const {name, unit, uid} = getData();
          const key = productKey(name, unit);
          const qty = selectedQuantities.get(key) ?? 0;
          if (qty <= 0) {
            showToast('Set a quantity first.');
            return;
          }
          adjustCartQuantity(name, unit, qty, uid);
          try { if (uid) window.pcpickCartAdd?.({ product_uid: uid, price: unit, quantity: qty }); } catch {}
          showToast(`${qty} × ${name} added to cart!`);
          updateSelection(key, 0);
        });

        qc.querySelector('.qty-plus')?.addEventListener('click', ()=>{
          const {name, unit} = getData();
          const key = productKey(name, unit);
          const current = selectedQuantities.get(key) ?? 0;
          updateSelection(key, current + 1);
        });
        qc.querySelector('.qty-minus')?.addEventListener('click', ()=>{
          const {name, unit} = getData();
          const key = productKey(name, unit);
          const current = selectedQuantities.get(key) ?? 0;
          updateSelection(key, current - 1);
        });

        amountInput?.addEventListener('input', ()=>{
          const {name, unit} = getData();
          const key = productKey(name, unit);
          const parsed = Math.max(0, Math.floor(Number(amountInput.value) || 0));
          amountInput.value = String(parsed);
          updateSelection(key, parsed);
        });
        });
      };

      // Initial wiring for static buttons
      wireNewAddToCartButtons();
      // Re-run after Supabase populates dynamic cards
      document.addEventListener('pcpick:prebuilt-populated', wireNewAddToCartButtons);

      // Apply server cart snapshot (if any)
      let snapshotApplied = false;
      const applyCartSnapshot = (rows=[]) => {
        if (snapshotApplied) return;
        try {
          let applied = 0;
          rows.forEach((r) => {
            const uid = r.uid;
            let name = r.name;
            let unit = Number(r.price || 0);
            if (!name || !unit) {
              const card = document.querySelector(`.product-card[data-uid="${uid}"]`);
              const domName = card?.querySelector('.product-info h3')?.textContent?.trim();
              const domUnit = parsePrice(card?.querySelector('.price')?.textContent?.trim() || 'PHP 0');
              name = name || domName || 'Item';
              if (!Number.isFinite(unit) || unit <= 0) unit = domUnit;
            }
            const qty = Math.max(0, Number(r.quantity || 0));
            if (qty > 0) { adjustCartQuantity(name, unit, qty, uid); applied++; }
          });
          if (applied > 0) snapshotApplied = true;
        } catch {}
      };
      document.addEventListener('pcpick:cart-snapshot', (e) => applyCartSnapshot(e.detail?.rows || []));
      // Listen for cross-tab/cart updates via localStorage
      window.addEventListener('storage', (e) => {
        if (e.key === 'pcpick:cart' && typeof e.newValue === 'string') {
          try { const parsed = JSON.parse(e.newValue || '{}'); applyCartSnapshot(parsed.rows || []); } catch {}
        }
      });
      // Seed from localStorage (fast) then Supabase (authoritative)
      try { const cached = JSON.parse(localStorage.getItem('pcpick:cart') || 'null'); if (cached?.rows) applyCartSnapshot(cached.rows); } catch {}
      window.pcpickGetCartSnapshot?.().then(applyCartSnapshot);
    })();
  </script>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    const checkoutBtn = document.querySelector(".checkout-btn");

    if (!checkoutBtn) return;

    checkoutBtn.addEventListener("click", async () => {

      // 1️⃣ CHECK IF USER IS LOGGED IN
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        alert("Please log in before checking out.");
        window.location.href = "login.html";
        return;
      }

      // 2️⃣ CHECK IF CART HAS ITEMS
      const cartIsEmpty = (Array.from(cartItems.values()).length === 0);

      if (cartIsEmpty) {
        alert("Your cart is empty.");
        return;
      }

      // 3️⃣ EVERYTHING OK → GO TO CHECKOUT PAGE
      window.location.href = "checkout.html";
    });
  });
  </script>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    const checkoutBtn = document.querySelector(".checkout-btn");

    if (!checkoutBtn) return;

    checkoutBtn.addEventListener("click", async () => {

      // 1️⃣ CHECK IF USER IS LOGGED IN
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        alert("Please log in before checking out.");
        window.location.href = "login.html";
        return;
      }

      // 2️⃣ CHECK IF CART HAS ITEMS (LOCAL CART)
      const cartIsEmpty = (Array.from(cartItems.values()).length === 0);

      if (cartIsEmpty) {
        alert("Your cart is empty.");
        return;
      }

      // 3️⃣ LOAD USER CART FROM DATABASE (user_cart table)
      if (window.pcpickLoadUserCartForCheckout) {
        await window.pcpickLoadUserCartForCheckout();
      }

      // 4️⃣ GO TO CHECKOUT PAGE
      window.location.href = "checkout.html";
    });
  });
  </script>
</body>
</html>
